# 架构决策记录 (Architecture Decision Records)

> 记录 Celest 项目中的重要架构决策，包括决策内容、理由和影响范围。

---

## ADR-001: Inspector 直接使用领域模型

**日期**: 2024-12-22  
**状态**: ✅ 已采纳

### 决策内容

`InspectorPanel` 组件直接使用 `CodeGraphNode` 领域模型，不创建视图模型层。

### 决策理由

1. **结构简单**：`CodeGraphNode` 的字段与 UI 需求基本一致，不需要复杂转换
2. **只读展示 + 简单编辑**：Inspector 主要是展示和简单编辑，不需要复杂的视图模型
3. **减少抽象层**：避免不必要的中间层，降低维护成本
4. **实用性优先**：当前阶段，直接使用领域模型更实用

### 替代方案

- **方案 A（已采纳）**：直接使用 `CodeGraphNode`
- **方案 B（未采纳）**：创建 `InspectorNodeViewModel` 视图模型层

### 影响范围

- `src/features/inspector/InspectorPanel.tsx` 直接使用 `CodeGraphNode`
- 不需要额外的 selector 或 adapter
- 简化了代码结构

### 何时需要重新考虑

如果未来出现以下情况，可能需要引入视图模型：
- Inspector 需要显示领域模型中没有的字段
- 需要多个不同的 Inspector 视图变体
- 领域模型结构变得复杂，包含大量 UI 不需要的字段

---

## ADR-002: Canvas 使用 Adapter 模式

**日期**: 2024-12-22  
**状态**: ✅ 已采纳

### 决策内容

Canvas 组件通过 `codeGraphToCanvas` adapter 将领域模型转换为视图模型。

### 决策理由

1. **需要复杂转换**：Canvas 需要坐标转换、选中态、视图模型等复杂逻辑
2. **视图模型与领域模型差异大**：Canvas 的 `CanvasNode` 包含位置、选中态等 UI 特定字段
3. **解耦 UI 和领域**：Canvas 是 UI 层，不应该直接依赖领域模型结构
4. **符合架构原则**：通过 adapter 隔离 UI 引擎和领域模型

### 实现方式

- `src/features/canvas/adapters/codeGraphToCanvas.ts` 负责转换
- `CanvasNode` 和 `CanvasEdge` 是视图模型类型
- Canvas 组件只使用视图模型，不直接使用 `CodeGraphModel`

### 影响范围

- Canvas 相关的所有组件都使用视图模型
- 领域模型变更不会直接影响 Canvas UI
- 保持了 UI ↔ Domain 的解耦

---

## ADR-003: 架构决策流程

**日期**: 2024-12-22  
**状态**: ✅ 已采纳

### 决策内容

建立架构决策流程：AI agents 发现问题时，应提出建议并说明理由，由用户最终决定。

### 决策理由

1. **用户缺乏架构经验**：用户难以判断哪些架构原则必须严格，哪些可以灵活
2. **AI 有产品理解**：AI 完全了解整个产品，可以提出合理建议
3. **协作效率**：通过讨论和决策，避免过度设计或违反原则
4. **记录决策**：重要决策记录在文档中，便于后续参考

### 流程

1. **识别问题**：AI 发现可能违反架构原则的情况
2. **提出建议**：说明问题，并提出建议（保持现状或修改）
3. **说明理由**：解释为什么建议这样做
4. **等待决策**：由用户最终决定是否采纳
5. **记录决策**：重要决策记录在 `docs/architecture-decisions.md`

### 影响范围

- 所有架构相关的决策都遵循此流程
- 避免 AI 过度设计或用户难以判断的情况
- 提高协作效率和代码质量

---

## ADR-004: 架构原则的严格程度

**日期**: 2024-12-22  
**状态**: ✅ 已采纳

### 决策内容

明确哪些架构原则必须严格遵循，哪些可以灵活处理。

### 必须严格遵循的原则

1. **分层边界**：
   - `entities/` 和 `core/` 不能导入 React
   - `state/` 不能导入 UI 引擎类型（如 ReactFlow、Monaco）

2. **模型分离**：
   - FS Index ≠ CodeGraph ≠ Knowledge Tree（严格分离）

3. **持久化**：
   - 持久化 schema 必须版本化
   - 必须有迁移函数

### 可以灵活处理的情况

1. **UI 组件直接使用领域模型**：
   - 如果结构简单，不需要复杂转换
   - 如果只是类型定义，不是逻辑依赖

2. **简单的数据展示**：
   - 不需要视图模型层
   - 直接使用领域模型更实用

### 判断标准

- 是否需要复杂转换？（是 → 需要 adapter/视图模型）
- 领域模型是否包含 UI 不需要的字段？（是 → 考虑视图模型）
- 是否需要多个视图变体？（是 → 考虑视图模型）
- 如果以上都是"否"，直接使用领域模型更实用

### 影响范围

- 指导所有架构相关的决策
- 避免过度设计或违反原则
- 提高代码的实用性

---

## 决策模板

使用以下模板记录新的架构决策：

```markdown
## ADR-XXX: [决策标题]

**日期**: YYYY-MM-DD  
**状态**: ✅ 已采纳 / ⏳ 待决定 / ❌ 已拒绝

### 决策内容

[简要描述决策内容]

### 决策理由

1. [理由 1]
2. [理由 2]
3. [理由 3]

### 替代方案

- **方案 A（已采纳）**：[描述]
- **方案 B（未采纳）**：[描述]

### 影响范围

- [影响 1]
- [影响 2]

### 何时需要重新考虑

[说明什么情况下需要重新评估此决策]
```

